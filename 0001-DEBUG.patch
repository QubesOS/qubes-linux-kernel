From 6f476152066b4c6b3509a1681aee824c87776a7c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marek=20Marczykowski-G=C3=B3recki?=
 <marmarek@invisiblethingslab.com>
Date: Mon, 27 Oct 2025 19:42:00 +0100
Subject: [PATCH] DEBUG

---
 drivers/net/xen-netfront.c         | 2 ++
 drivers/xen/xenbus/xenbus_client.c | 9 +++++++++
 2 files changed, 11 insertions(+)

diff --git a/drivers/net/xen-netfront.c b/drivers/net/xen-netfront.c
index a11a0e9494005..e6a2d72764fce 100644
--- a/drivers/net/xen-netfront.c
+++ b/drivers/net/xen-netfront.c
@@ -1817,6 +1817,7 @@ static void xennet_disconnect_backend(struct netfront_info *info)
 	unsigned int i = 0;
 	unsigned int num_queues = info->netdev->real_num_tx_queues;
 
+	printk(KERN_CRIT "xennet_disconnect_backend info %p\n", info);
 	netif_carrier_off(info->netdev);
 
 	for (i = 0; i < num_queues && info->queues; ++i) {
@@ -2659,6 +2660,7 @@ static void xennet_remove(struct xenbus_device *dev)
 {
 	struct netfront_info *info = dev_get_drvdata(&dev->dev);
 
+	printk(KERN_CRIT "xennet_remove %p\n", dev);
 	xennet_bus_close(dev);
 	xennet_disconnect_backend(info);
 
diff --git a/drivers/xen/xenbus/xenbus_client.c b/drivers/xen/xenbus/xenbus_client.c
index ce2f49d9aa4ad..d1481ccc41ea2 100644
--- a/drivers/xen/xenbus/xenbus_client.c
+++ b/drivers/xen/xenbus/xenbus_client.c
@@ -275,6 +275,15 @@ __xenbus_switch_state(struct xenbus_device *dev,
  */
 int xenbus_switch_state(struct xenbus_device *dev, enum xenbus_state state)
 {
+	if (WARN(state == XenbusStateClosed || state == XenbusStateClosing,
+	     "switching %s (%p) to state %d, otherend: %s, vanished: %d\n",
+	  	   dev->nodename, dev, state, dev->otherend, dev->vanished)) {
+		char *otherend = NULL;
+		int err = xenbus_gather(XBT_NIL, dev->nodename, "backend", NULL, &otherend, NULL);
+		printk(KERN_CRIT "xs (%d): backend: %s\n", err, otherend);
+		if (otherend)
+			kfree(otherend);
+	}
 	if (dev->vanished)
 		return 0;
 	return __xenbus_switch_state(dev, state, 0);
-- 
2.51.0

